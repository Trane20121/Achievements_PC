<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8" />
    <title>Steam Achievement Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --blue: #66c0f4;
            --bg: #1b2838;
            --card: #171a21;
            --gold: #ffd700;
            --muted: #88929b;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: #c7d5e0;
            margin: 0;
            padding: 20px;
        }

        .nav {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        input,
        button {
            background: #101822;
            border: 1px solid #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.03);
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 240px;
        }

        .card:hover {
            border-color: var(--blue);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .img-container {
            width: 100%;
            height: 110px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .title {
            font-weight: bold;
            font-size: 0.95em;
            color: white;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            height: 2.6em;
        }

        .meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: var(--muted);
            align-items: center;
            margin-top: auto;
        }

        .prog-bg {
            height: 6px;
            background: #000;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }

        .prog-fill {
            height: 100%;
            background: var(--blue);
            width: 0%;
            transition: width 0.8s;
        }

        .completed .prog-fill {
            background: var(--gold);
        }

        .sp {
            width: 12px;
            height: 12px;
            border: 2px solid #333;
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #171d25;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--blue);
            z-index: 1000;
            width: 360px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Achievements list */
        .ach-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            background: rgba(255, 255, 255, 0.02);
            padding: 8px;
            border-radius: 8px;
        }

        .ach-item img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 6px;
        }

        .ach-text {
            flex: 1;
        }

        .ach-name {
            font-weight: 600;
            color: white;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ach-desc {
            color: var(--muted);
            font-size: 0.85em;
            margin-top: 4px;
        }

        .ach-badge {
            font-size: 0.95em;
            color: var(--gold);
            margin-left: 6px;
        }
    </style>
</head>

<body>

    <div class="nav">
        <input id="key" type="password" placeholder="API Key" style="width: 100px">
        <input id="sid" type="text" placeholder="SteamID64" style="width: 140px">
        <span>Per pagina:</span>
        <input id="maxGames" type="number" value="40" style="width: 50px">
        <button onclick="onLoadClick()"
            style="background: var(--blue); color: black; font-weight: bold">Aggiorna</button>
        <button onclick="prevPage()">â—€</button>
        <span id="pageInfo">Pagina 1 / 1</span>
        <button onclick="nextPage()">â–¶</button>
        <input id="search" type="text" placeholder="Cerca..." oninput="currentPage=0;render()" style="flex: 1">
        <div id="totalStats">0h</div>
    </div>

    <div id="list" class="grid"></div>

    <div id="overlay" onclick="closePop()"></div>
    <div id="popup">
        <h3 id="p-title" style="margin:0 0 10px 0; color: var(--blue)"></h3>
        <div style="display:flex; gap:12px; margin-bottom:10px; align-items:center;">
            <div
                style="width:80px; height:80px; background:#0b0f12; border-radius:8px; display:flex; align-items:center; justify-content:center;">
                <img id="p-img" src="" alt="" style="max-width:78px; max-height:78px; border-radius:6px;">
            </div>
            <div>
                <div id="p-sub" style="color:var(--muted); font-size:0.9em"></div>
                <div id="p-stats" style="margin-top:6px; font-weight:bold"></div>
            </div>
        </div>

        <div style="height:260px; overflow:auto; padding-right:6px;" id="ach-list-container">
            <div id="ach-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <button onclick="closePop()"
            style="width:100%; margin-top:12px; background:#333; color:white; padding:8px; border-radius:6px; border:none; cursor:pointer;">Chiudi</button>
    </div>

    <script>
        const API = "http://localhost:5000/api";
        let allGames = [];
        let currentPage = 0;
        let chart = null;

        async function onLoadClick() {
            const body = { steam_key: document.getElementById('key').value, steam_id: document.getElementById('sid').value };
            await fetch(`${API}/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const res = await fetch(`${API}/steam/games_summary`);
            const data = await res.json();
            allGames = data.games;
            document.getElementById('totalStats').innerText = Math.round(allGames.reduce((acc, g) => acc + g.playtime, 0) / 60) + "h";
            currentPage = 0;
            render();
        }

        function render() {
            const pageSize = parseInt(document.getElementById('maxGames').value) || 20;
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allGames.filter(g => g.name.toLowerCase().includes(term));
            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            document.getElementById('pageInfo').innerText = `Pagina ${currentPage + 1} / ${totalPages}`;

            const slice = filtered.slice(currentPage * pageSize, (currentPage + 1) * pageSize);

            document.getElementById('list').innerHTML = slice.map(g => `
        <div class="card" id="card-${g.appid}" onclick="openPop('${g.appid}')">
          <div class="img-container"><img src="${g.img}"></div>
          <div class="card-info">
            <div class="title">${g.name}</div>
            <div class="meta">
              <span>${Math.round(g.playtime / 60)}h</span>
              <span id="ach-${g.appid}"><div class="sp"></div></span>
              <span id="dlc-${g.appid}">ðŸ“¦ ?/?</span>
            </div>
            <div class="prog-bg"><div id="bar-${g.appid}" class="prog-fill"></div></div>
          </div>
        </div>
      `).join('');
            fetchDetails(slice);
        }

        async function fetchDetails(games) {
            const appids = games.map(g => g.appid);
            const aRes = await fetch(`${API}/steam/achievements_bulk`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ appids })
            });
            const achs = await aRes.json();

            appids.forEach(async id => {
                const a = achs[id];
                const g = allGames.find(x => x.appid === id);
                if (a) {
                    g.u = a.u; g.t = a.t;
                    document.getElementById(`ach-${id}`).innerHTML = `<b>${a.u}</b>/${a.t}`;
                    document.getElementById(`bar-${id}`).style.width = (a.t > 0 ? (a.u / a.t * 100) : 0) + "%";
                    if (a.t > 0 && a.u === a.t) document.getElementById(`card-${id}`).classList.add('completed');
                }
                const dRes = await fetch(`${API}/steam/game_details/${id}`);
                const d = await dRes.json();
                g.dlc_owned = d.owned_dlc; g.dlc_total = d.total_dlc;
                document.getElementById(`dlc-${id}`).innerText = `ðŸ“¦ ${d.owned_dlc}/${d.total_dlc}`;
            });
        }

        async function openPop(appid) {
            const g = allGames.find(x => x.appid === appid);
            if (!g) return;
            document.getElementById('p-title').innerText = g.name;
            document.getElementById('p-img').src = g.img;
            document.getElementById('p-sub').innerText = `${Math.round(g.playtime / 60)}h di gioco`;
            document.getElementById('p-stats').innerText = `Obiettivi: ${g.u || 0}/${g.t || 0} â€¢ DLC: ${g.dlc_owned || 0}/${g.dlc_total || 0}`;

            document.getElementById('ach-list').innerHTML = '<div style="color:var(--muted);padding:10px">Caricamento trofeiâ€¦</div>';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';

            try {
                const [schemaRes, playerRes] = await Promise.all([
                    fetch(`${API}/steam/schema/${appid}`),
                    fetch(`${API}/steam/player_achievements/${appid}`)
                ]);
                const schemaJson = await schemaRes.json();
                const playerJson = await playerRes.json();

                const schema = schemaJson.achievements || [];
                const playerMap = playerJson.achievements || {};

                if (!schema.length) {
                    document.getElementById('ach-list').innerHTML = '<div style="color:var(--muted);padding:10px">Nessun schema trofei disponibile per questo gioco.</div>';
                    return;
                }

                const listEl = document.getElementById('ach-list');
                listEl.innerHTML = '';
                schema.forEach(a => {
                    const key = a.name || a.displayName;
                    const player = playerMap[key] || playerMap[a.displayName] || playerMap[a.name] || { achieved: 0 };
                    const unlocked = player.achieved && parseInt(player.achieved) === 1;
                    const icon = unlocked ? (a.icon || a.icongray) : (a.icongray || a.icon || '');
                    const unlocktime = player.unlocktime ? new Date(player.unlocktime * 1000).toLocaleString() : '';

                    const item = document.createElement('div');
                    item.className = 'ach-item';
                    item.innerHTML = `
            <img src="${icon}" onerror="this.style.opacity=0.6; this.src='${a.icongray || ''}';">
            <div class="ach-text">
              <div class="ach-name">${escapeHtml(a.displayName || a.name || '')} ${unlocked ? '<span class="ach-badge">âœ…</span>' : ''}</div>
              <div class="ach-desc">${escapeHtml(a.description || '')}${unlocked && unlocktime ? ' â€” <span style="color:var(--muted);font-size:0.8em">sbloccato: ' + unlocktime + '</span>' : ''}</div>
            </div>
          `;
                    listEl.appendChild(item);
                });

            } catch (e) {
                document.getElementById('ach-list').innerHTML = '<div style="color:salmon;padding:10px">Errore nel caricamento dei trofei.</div>';
            }
        }

        function closePop() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
        }
        function prevPage() { if (currentPage > 0) { currentPage--; render(); window.scrollTo(0, 0); } }
        function nextPage() { if ((currentPage + 1) * parseInt(document.getElementById('maxGames').value) < allGames.length) { currentPage++; render(); window.scrollTo(0, 0); } }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        window.onload = async () => {
            const res = await fetch(`${API}/data`);
            const d = await res.json();
            document.getElementById('key').value = d.steam_key || "";
            document.getElementById('sid').value = d.steam_id || "";
        };
    </script>
</body>

</html>